FROM apache/airflow:2.8.0-python3.12

USER root
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv
RUN chmod +x /usr/local/bin/uv

USER airflow
WORKDIR /opt/airflow

COPY --chown=airflow:root pyproject.toml .
RUN uv sync --frozen --no-dev --no-install-project

COPY --chown=airflow:root src/ src/
COPY --chown=airflow:root alembic.ini .
COPY --chown=airflow:root migrations/ migrations/

RUN uv sync --frozen --no-dev

ENV PYTHONPATH="/opt/airflow/src:${PYTHONPATH}"
